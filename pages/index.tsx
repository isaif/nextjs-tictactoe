import Head from "next/head";
import { useState, useEffect } from "react";
import { useRouter } from "next/router";

const gameUrl = "http://127.0.0.1:4000/playerId";

const Home = () => {
  const [gameId, setGameId] = useState("");
  const [playerId, setPlayerId] = useState<String | null>(null);
  const router = useRouter();

  useEffect(() => {
    const id = localStorage.getItem("playerId");
    if (id) {
      setPlayerId(id);
    } else {
      fetchPlayerId();
    }
  }, []);

  const fetchPlayerId = async () => {
    try {
      const response = await fetch(gameUrl);
      const data = await response.json();
      const id = await data.playerId;
      setPlayerId(id);
      localStorage.setItem("playerId", id);
    } catch (error) {
      //TODO: better error handling
      console.log(error);
    }
  };

  const handleCreateGame = async () => {
    // const response = await fetch(gameUrl, { method: "POST" });
    const response = await fetch(gameUrl);
    const { playerId } = await response.json();
    localStorage.setItem("playerId", playerId);
  };

  const handleJoinRoom = () => {
    router.push(`/game/${gameId}`);
  };

  const handleRoomIdChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    setGameId(event.target.value);
  };

  return (
    <>
      <Head>
        <title>TicTacToe</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div>
        <h1>Tic Tac Toe</h1>
        <button onClick={handleCreateGame}>Create Room</button>
        <div>
          <label htmlFor="game-id">Room ID:</label>
          <input
            type="text"
            id="game-id"
            value={gameId}
            onChange={handleRoomIdChange}
          />
          <button onClick={handleJoinRoom}>Join Room</button>
        </div>
      </div>
    </>
  );
};

export default Home;
